#!/usr/bin/env bash

dir="$PWD"
args=()
while [ $# -gt 0 ]; do
	if [ "$1" = "-d" ] && [ -n "$2" ]; then
		dir="$2"
		shift 2
	else
		args=("${args[@]}" "$1")
		shift
	fi
done
dir="$(realpath "$dir")"

hash="$(md5sum <<<"$dir" | cut -c1-32)"
inputsocket="/tmp/neuron-socket-in-$hash"
outputstatussocket="/tmp/neuron-socket-out-status-$hash"
outputstdoutsocket="/tmp/neuron-socket-out-stdout-$hash"
outputstderrsocket="/tmp/neuron-socket-out-stderr-$hash"

if [ ! -p "$inputsocket" ] || [ ! -p "$outputstatussocket" ] || [ ! -p "$outputstdoutsocket" ] || [ ! -p "$outputstderrsocket" ]; then
	echo >&2 "No neuron worker is running for '$dir', please start one first."
	exit 1
fi

exec 4>"$inputsocket"
exec 5<"$outputstatussocket"
cat "$outputstdoutsocket" &
cat "$outputstderrsocket" >&2 &

(
	printf '%q ' neuron -d /zettelkasten "${args[@]}"
	printf '\n'
) >&4

read -u 5 -r status
jobs -p | xargs kill
exit "$status"
