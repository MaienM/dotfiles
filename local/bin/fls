#!/usr/bin/env bash

# A fancier-looking ls-like command, based on fancy find.

# Arguments thatb start with a plus are options for ffind, and should be passed on.
ffind_args=()
targets=()
while [ "$#" -gt 0 ]; do
	arg="$1"
	shift 1
	case "$arg" in
		+*) ffind_args=("${ffind_args[@]}" "$arg") ;;
		--) break ;;
		*) targets=("${targets[@]}" "$arg") ;;
	esac
done
targets=("${targets[@]}" "$@")

# If no targets are given, default to the current directory (as ls does).
if [ "${#targets[@]}" -eq 0 ]; then
	targets=("$PWD")
fi

# Determine whether at least one of the arguments is a directory. If this is the case, we need to print headers above
# each ffind command. If not, we can opt for a more compact syntax.
listing_a_dir=false
for path in "${targets[@]}"; do
	[ -d "$path" ] && listing_a_dir=true
done

isfirst=true
for path in "${targets[@]}"; do
	if [ "${#targets[@]}" -gt 1 ] && $listing_a_dir; then
		$isfirst || printf '\n'
		printf '%s:\n' "$path"
	fi
	isfirst=false

	if [ -d "$path" ]; then
		ffind "${ffind_args[@]}" "$path" -mindepth 1 -maxdepth 1 \
			| awk -v "needle=$path/" '{ sub(needle, ""); print }'
	else
		ffind "${ffind_args[@]}" "$path"
	fi
done
